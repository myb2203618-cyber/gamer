<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <script>
    AFRAME.registerComponent('scene-switch', {
      schema: {
        target: { type: 'selector' }
      },
      init: function () {
        this.el.addEventListener('click', () => {
          // Tìm scene cha hiện tại đang chứa nút được bấm
          const currentScene = this.el.closest('a-entity[id]');
          if (currentScene) currentScene.setAttribute('visible', false);

          // Hiện scene mục tiêu
          if (this.data.target) this.data.target.setAttribute('visible', true);
        });
      }
    });
    ////////////////////////////////////////////////////////////////
    //////QUIZ - phancauhoi
    AFRAME.registerComponent('quiz-logic', {
      init: function () {
        // 1. Dữ liệu câu hỏi: 'correct' từ 0 đến 3 (tương ứng 4 nút bấm)
        this.questions = [
          { qImage: "#c1", correct: 3 }, // Nút thứ 4 đúng
          { qImage: "#c2", correct: 1 }, // Nút thứ 2 đúng
          { qImage: "#c3", correct: 2 }, // Nút thứ 3 đúng
          { qImage: "#c4", correct: 2 }, // Nút thứ 1 đúng
          { qImage: "#c5", correct: 0 }  // Nút thứ 3 đúng
        ];

        this.currentQuestionIndex = 0;
        this.totalQuestions = 4; // Số câu hỏi cần trả lời để qua màn

        // Trộn ngẫu nhiên danh sách câu hỏi
        this.questions = this.questions.sort(() => Math.random() - 0.5);

        // Lấy các thực thể từ HTML
        this.questionDisplay = document.querySelector("#question-board");

        // Quan trọng: Chọn tất cả các nút có class .quiz-option
        this.optionButtons = this.el.querySelectorAll(".quiz-option");

        // Gán sự kiện click cho 4 nút
        this.optionButtons.forEach((btn, index) => {
          btn.addEventListener('click', () => {
            // Chỉ xử lý click nếu Scene Quiz đang hiển thị
            if (this.el.getAttribute('visible') === true) {
              this.checkAnswer(index);
            }
          });
        });

        this.loadQuestion();
      },

      loadQuestion: function () {
        // Kiểm tra nếu chưa hết số lượng câu hỏi mục tiêu
        if (this.currentQuestionIndex < this.totalQuestions) {
          const currentQ = this.questions[this.currentQuestionIndex];

          // Đổi ảnh câu hỏi trên tấm Plane
          if (this.questionDisplay) {
            this.questionDisplay.setAttribute('src', currentQ.qImage);
          }
        } else {
          // HOÀN THÀNH: Chuyển sang Scene Assembly
          this.el.setAttribute('visible', false);
          const assemblyScene = document.querySelector("#assembly");
          if (assemblyScene) {
            assemblyScene.setAttribute('visible', true);
          }
        }
      },

      checkAnswer: function (selectedIndex) {
        const currentQ = this.questions[this.currentQuestionIndex];

        if (selectedIndex === currentQ.correct) {
          console.log("Chính xác!");
          this.currentQuestionIndex++;
          this.loadQuestion();
        } else {
          console.log("Sai rồi! Hãy chọn lại.");
          // Hiệu ứng rung nhẹ khi chọn sai (tùy chọn)
          this.el.setAttribute('animation', "property: position; from: 0 0 0.01; to: 0 0 0; dur: 50; iterations: 4");
        }
      }
    });
  </script>
  <title>AR Quiz 5 Scenes</title>
</head>

<body>
  <a-scene mindar-image="imageTargetSrc: targets.mind" color-space="sRGB"
    renderer="colorManagement: true, physicallyCorrectLights: true" vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false">

    <a-assets>
      <a-asset-item id="logo" src="asset/logo.glb"></a-asset-item>
      <a-asset-item id="start" src="asset/start.glb"></a-asset-item>
      <a-asset-item id="link" src="asset/link.glb"></a-asset-item>
      <a-asset-item id="list" src="asset/list.glb"></a-asset-item>
      <a-asset-item id="node" src="asset/nut.glb"></a-asset-item>
      <a-asset-item id="ans" src="asset/cautraloi.glb"></a-asset-item>
      <img id="c1" src="asset/ans/c1.png">
      <img id="c2" src="asset/ans/c2.png">
      <img id="c3" src="asset/ans/c3.png">
      <img id="c4" src="asset/ans/c4.png">
      <img id="c5" src="asset/ans/c5.png">
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false" cursor="fuse: false; rayOrigin: mouse;"
      raycaster="objects: .clickable"></a-camera>

    <a-entity mindar-image-target="targetIndex: 0">

      <a-entity id="welcome" visible="true">
        <a-gltf-model src="#logo" position="0 0 0" scale="0.1 0.1 0.1"
          animation-mixer="loop: once; clampWhenFinished: true">
        </a-gltf-model>
        <a-gltf-model class="clickable" scene-switch="target: #quiz" src="#start" position="0.5 0.6 0"
          scale="0.1 0.1 0.1" rotation="0 90 0"></a-gltf-model>
        <a-gltf-model src="#link" position="0.5 0.3 0" scale="0.1 0.1 0.1" rotation="0 90 0"></a-gltf-model>
        <a-gltf-model scene-switch="target: #leaderboard" src="#list" position="0.5 0 0" scale="0.1 0.1 0.1"
          rotation="0 90 0"></a-gltf-model>

      </a-entity>

      <a-entity id="leaderboard" visible="false">
        <a-text value="LEADERBOARD" align="center" position="0 0.5 0" color="yellow"></a-text>
        <a-gltf-model class="clickable" scene-switch="target: #welcome" src="#node" position="0 -0.5 0"
          scale="0.05 0.05 0.05"></a-gltf-model>
      </a-entity>

      <a-entity id="quiz" visible="false" quiz-logic>

        <a-plane id="question-board" position="0 0.6 0" width="1.2" height="0.6"
          material="transparent: true; shader: flat">
        </a-plane>

        <a-gltf-model class="clickable quiz-option" src="#node" position="-0.45 0 0" scale="0.1 0.1 0.1"></a-gltf-model>
        <a-gltf-model class="clickable quiz-option" src="#node" position="-0.15 0 0" scale="0.1 0.1 0.1"></a-gltf-model>
        <a-gltf-model class="clickable quiz-option" src="#node" position="0.15 0 0" scale="0.1 0.1 0.1"></a-gltf-model>
        <a-gltf-model class="clickable quiz-option" src="#node" position="0.45 0 0" scale="0.1 0.1 0.1"></a-gltf-model>

      </a-entity>

      <a-entity id="assembly" visible="false">
        <a-gltf-model src="#logo" position="0 0 0" scale="0.15 0.15 0.15"
          animation="property: rotation; to: 0 360 0; loop: true; dur: 5000"></a-gltf-model>
        <a-gltf-model class="clickable" scene-switch="target: #reward" src="#node" position="0 -0.5 0"
          scale="0.1 0.1 0.1"></a-gltf-model>
      </a-entity>

      <a-entity id="reward" visible="false">
        <a-text value="CHUC MUNG! BAN NHAN DUOC VOUCHER 50%" align="center" position="0 0.3 0"
          scale="0.4 0.4 0.4"></a-text>
        <a-gltf-model class="clickable" scene-switch="target: #welcome" src="#node" position="0 -0.3 0"
          scale="0.1 0.1 0.1"></a-gltf-model>
      </a-entity>

    </a-entity>
  </a-scene>
</body>

</html>